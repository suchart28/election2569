<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Thailand Election Leaderboard 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #fdfdfd; font-family: 'Sarabun', sans-serif; }
        .party-card { border: none; border-radius: 15px; transition: 0.3s; overflow: hidden; }
        .party-color-bar { height: 8px; width: 100%; }
        .score-big { font-size: 2.5rem; font-weight: bold; color: #1a1a1a; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h2 class="fw-bold">Leaderboard พรรคการเมือง</h2>
            <p class="text-muted">สรุปจำนวน สส. และคะแนนยอดนิยม (Popular Vote) ทั่วประเทศ</p>
        </div>
    </div>

    <div class="row mb-5 justify-content-center">
        <div class="col-md-8">
            <div class="card p-4 shadow-sm border-0">
                <canvas id="partyChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4" id="partyLeaderboard">
        </div>
</div>

<script>
async function fetchElectionData() {
    try {
        // ใช้ Proxy เพื่อเลี่ยง CORS (สำหรับการทดสอบ)
        const proxy = "https://api.allorigins.win/raw?url=";
        const urlResult = encodeURIComponent("https://static-ectreport69.ect.go.th/data/data/result/result_all.json");
        const urlParty = encodeURIComponent("https://static-ectreport69.ect.go.th/data/data/refs/info_party.json");

        const [resScore, resParty] = await Promise.all([
            fetch(proxy + urlResult).then(r => r.json()),
            fetch(proxy + urlParty).then(r => r.json())
        ]);

        // 1. สร้าง Map ข้อมูลพรรคเพื่อให้ดึงใช้ง่ายๆ
        const partyMap = {};
        resParty.forEach(p => {
            partyMap[p.id] = { name: p.name, color: p.color, abbrev: p.abbrev };
        });

        // 2. ประมวลผลคะแนน (รวม สส. เขต + สส. บัญชีรายชื่อ)
        const sortedParties = resScore.sort((a, b) => (b.total_seat) - (a.total_seat)).slice(0, 6);

        renderUI(sortedParties, partyMap);
        renderChart(sortedParties, partyMap);

    } catch (error) {
        console.error("Error fetching data:", error);
    }
}

function renderUI(data, partyMap) {
    const container = document.getElementById('partyLeaderboard');
    container.innerHTML = data.map(p => {
        const info = partyMap[p.party_id] || { name: 'ไม่ทราบชื่อพรรค', color: '#ccc' };
        return `
            <div class="col-md-4">
                <div class="card party-card shadow-sm h-100">
                    <div class="party-color-bar" style="background-color: ${info.color}"></div>
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-1">${info.name}</h6>
                        <div class="score-big">${p.total_seat}</div>
                        <p class="mb-0 text-uppercase small fw-bold">ที่นั่ง สส. รวม</p>
                        <hr>
                        <div class="d-flex justify-content-between px-3">
                            <small>สส. เขต: <b>${p.cons_seat}</b></small>
                            <small>สส. บัญชีฯ: <b>${p.list_seat}</b></small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderChart(data, partyMap) {
    const ctx = document.getElementById('partyChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(p => partyMap[p.party_id]?.abbrev || p.party_id),
            datasets: [{
                label: 'จำนวนที่นั่ง สส. รวม',
                data: data.map(p => p.total_seat),
                backgroundColor: data.map(p => partyMap[p.party_id]?.color || '#000'),
                borderRadius: 10
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });
}

fetchElectionData();
</script>
</body>
</html>
